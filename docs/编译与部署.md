# 编译与部署


## 调试模式编译
```
# Package app/blinky
cargo build -p blinky
```

## 生产环境编译
```
# Package app/blinky
cargo build -r -p blinky
```


## 它将产生一个空的二进制项
- input
```shell
cargo size --target thumbv7m-none-eabi --bin app
```

- output
```shell
   Compiling app v0.1.0 (/home/one/Documents/code/RustEmbedProject/app)
    Finished dev [unoptimized + debuginfo] target(s) in 0.15s
   text    data     bss     dec     hex filename
      0       0       0       0       0 app
```

## 在链接之前，crate 包含恐慌函数的符号
- input
```shell
cargo rustc --target thumbv7m-none-eabi -- --emit=obj

cargo nm -- target/thumbv7m-none-eabi/debug/deps/app-*.o | grep '[0-9]* [^N] '

- output
```
```shell
   Compiling app v0.1.0 (/home/one/Documents/code/RustEmbedProject/app)
error: could not compile `app` (bin "app") due to 2 previous errors
error: Failed to parse crate metadata
```

## 链接器脚本编译
```shell
cargo rustc -- -C link-arg=-Tlink.x
```

## 反汇编检查输出的二进制项
确保存储布局跟我们想要的一样 (这需要 cargo-binutils)
```shell
cargo objdump --bin app -- -d --no-show-raw-insn
```

## 反汇编检查 .vector_table section 的内容
```shell
cargo objdump --bin app -- -s --section .vector_table
```

## 优化过的版本的反汇编
```shell
cargo objdump --bin app --release -- -d --no-show-raw-insn --print-imm-hex
```

## 测试
这个程序是一个有效的LM3S6965程序；我们可以在一个虚拟微控制器(QEMU)中执行它去测试。

### 启动
这个程序将会阻塞住。
```shell
qemu-system-arm \
      -cpu cortex-m3 \
      -machine lm3s6965evb \
      -gdb tcp::3333 \
      -S \
      -nographic \
      -kernel target/thumbv7m-none-eabi/debug/app
```

## 参考文档
[cargo 清单格式](https://rustwiki.org/zh-CN/cargo/reference/manifest.html?highlight=%5B%5Bbin%5D%5D#the-project-layout)
[cargo 定义项目示例和可执行程序](https://blog.csdn.net/totramp/article/details/118934303)
